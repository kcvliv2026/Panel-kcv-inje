<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KCV VIP PANEL</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
    body { background: #000; color: #fff; padding: 20px; }

    /* HEADER */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
    .panel-name { color: #00ffcc; font-size: 28px; text-shadow: 0 0 5px #00ffcc; }
    .header-right { text-align: right; }
    .points { font-size: 18px; color: #fff; margin-bottom: 5px; }
    .points span { color: #ffcc00; font-weight: bold; }
    .logout-btn { background: #ff4444; color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    .logout-btn:hover { background: #ff6666; }
    .timer { color: #ff4444; font-size: 14px; margin-top: 5px; }

    /* CONTROL BUTTONS */
    .control-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .control-btn { padding: 10px 15px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 14px; }
    .btn-green { background: #00cc99; color: #000; }
    .btn-green:hover { background: #00ffcc; }
    .btn-blue { background: #0099ff; color: #fff; }
    .btn-blue:hover { background: #00ccff; }

    /* KEY GENERATION SECTION */
    .key-gen-section { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 20px; padding: 15px; background: #111; border-radius: 5px; }
    .key-gen-section select, .key-gen-section input { padding: 8px; background: #222; border: 1px solid #00ffcc; color: #fff; border-radius: 5px; outline: none; }
    .gen-key-btn { background: #00cc99; color: #000; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .gen-key-btn:hover { background: #00ffcc; }
    .delete-section { margin-left: auto; display: flex; gap: 10px; align-items: center; }
    .delete-section select { width: 150px; }
    .confirm-btn { background: #ff4444; color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }

    /* KEYS TABLE */
    .keys-table { width: 100%; border-collapse: collapse; background: #111; border-radius: 5px; overflow: hidden; }
    .keys-table th, .keys-table td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
    .keys-table th { background: #222; color: #00ffcc; font-weight: bold; }
    .keys-table td { color: #fff; }
    .keys-table .active { color: #00ffcc; font-weight: bold; }
    .keys-table .control-btn { padding: 6px 10px; font-size: 12px; }

    /* MODALS */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 100; }
    .modal-content { background: #111; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; }
    .modal-content h3 { color: #00ffcc; margin-bottom: 15px; }
    .modal-content input { width: 100%; padding: 10px; margin: 10px 0; background: #222; border: 1px solid #00ffcc; color: #fff; border-radius: 5px; }
    .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
    .close-btn { background: #666; color: #fff; }
    .close-btn:hover { background: #888; }

    /* MESSAGES */
    .message { text-align: center; margin: 10px 0; padding: 10px; border-radius: 5px; }
    .success { background: #004422; color: #00ffcc; }
    .error { background: #440000; color: #ff4444; }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <h1 class="panel-name">KCV VIP PANEL</h1>
    <div class="header-right">
      <p class="points">Points: <span id="panel-points">0</span></p>
      <button class="logout-btn" onclick="logout()">Logout</button>
      <p class="timer">Session: 60:00</p>
    </div>
  </div>

  <!-- CONTROL BUTTONS -->
  <div class="control-buttons">
    <button class="control-btn btn-green" onclick="openResellerModal()">Create Reseller</button>
    <button class="control-btn btn-green" onclick="toggleMaintenance()">Maintenance Mode</button>
    <button class="control-btn btn-blue">Get Key Generate</button>
    <button class="control-btn btn-blue">Control Website</button>
  </div>

  <!-- KEY GENERATION SECTION -->
  <div class="key-gen-section">
    <select id="key-type">
      <option value="VIP">VIP</option>
      <option value="Free">Free</option>
    </select>
    <select id="key-duration">
      <option value="1 Day">1 Day (6 points)</option>
      <option value="7 Days">7 Days (30 points)</option>
      <option value="Lifetime">Lifetime (100 points)</option>
    </select>
    <select id="device-slot">
      <option value="1">Device Slot (1)</option>
      <option value="2">Device Slot (2)</option>
    </select>
    <button class="gen-key-btn" onclick="generateKey()">Generate Key</button>
    <div class="delete-section">
      <select id="delete-key">
        <option value="">Select Key to Delete</option>
      </select>
      <button class="confirm-btn">Confirm</button>
    </div>
  </div>

  <!-- KEYS TABLE -->
  <table class="keys-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Key</th>
        <th>Status</th>
        <th>Type</th>
        <th>Expiry</th>
        <th>User</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="keys-table-body">
      <!-- Data will load here -->
    </tbody>
  </table>

  <!-- CREATE RESELLER MODAL -->
  <div class="modal" id="reseller-modal">
    <div class="modal-content">
      <h3>Create New Reseller</h3>
      <input type="text" id="reseller-username" placeholder="Reseller Username">
      <input type="number" id="reseller-points" placeholder="Reseller Points" min="100">
      <div class="modal-buttons">
        <button class="control-btn close-btn" onclick="closeResellerModal()">Cancel</button>
        <button class="control-btn btn-green" onclick="saveReseller()">Create</button>
      </div>
    </div>
  </div>

  <!-- MESSAGE BOX -->
  <div class="message" id="message-box" style="display: none;"></div>

  <script>
    const VERCEL_URL = window.location.origin;
    const token = localStorage.getItem("kcv_token");
    const points = localStorage.getItem("kcv_points");
    let panelData = {};

    // CHECK IF LOGGED IN
    if (!token) {
      window.location.href = "/";
    } else {
      document.getElementById("panel-points").textContent = points;
      loadPanelData();
    }

    // LOAD ALL PANEL DATA
    function loadPanelData() {
      fetch(`${VERCEL_URL}/api/panel-data`, {
        headers: { "Authorization": `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          panelData = data;
          updateKeysTable();
          updateDeleteDropdown();
        } else {
          showMessage("Failed to load data!", "error");
        }
      })
      .catch(() => showMessage("Connection error!", "error"));
    }

    // UPDATE KEYS TABLE
    function updateKeysTable() {
      const tableBody = document.getElementById("keys-table-body");
      tableBody.innerHTML = "";

      panelData.generatedKeys.forEach(key => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${key.id}</td>
          <td>${key.key}</td>
          <td class="active">${key.status}</td>
          <td>${key.type}</td>
          <td>${key.expiry}</td>
          <td>${key.user}</td>
          <td><button class="control-btn btn-blue">Control</button></td>
        `;
        tableBody.appendChild(row);
      });
    }

    // UPDATE DELETE KEY DROPDOWN
    function updateDeleteDropdown() {
      const dropdown = document.getElementById("delete-key");
      dropdown.innerHTML = '<option value="">Select Key to Delete</option>';

      panelData.generatedKeys.forEach(key => {
        const option = document.createElement("option");
        option.value = key.id;
        option.textContent = key.key;
        dropdown.appendChild(option);
      });
    }

    // GENERATE NEW KEY
    function generateKey() {
      const type = document.getElementById("key-type").value;
      const duration = document.getElementById("key-duration").value;
      const devices = document.getElementById("device-slot").value;

      fetch(`${VERCEL_URL}/api/generate-key`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ type, duration, devices })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showMessage(`Key generated: ${data.newKey}`, "success");
          document.getElementById("panel-points").textContent = data.updatedPoints;
          loadPanelData();
        } else {
          showMessage(data.message, "error");
        }
      });
    }

    // TOGGLE MAINTENANCE MODE
    function toggleMaintenance() {
      fetch(`${VERCEL_URL}/api/toggle-maintenance`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        showMessage(data.message, "success");
      });
    }

    // RESELLER MODAL FUNCTIONS
    function openResellerModal() {
      document.getElementById("reseller-modal").style.display = "flex";
    }
    function closeResellerModal() {
      document.getElementById("reseller-modal").style.display = "none";
    }
    function saveReseller() {
      const username = document.getElementById("reseller-username").value.trim();
      const points = document.getElementById("reseller-points").value.trim();

      if (!username || !points) {
        showMessage("Fill all fields!", "error");
        return;
      }

      fetch(`${VERCEL_URL}/api/create-reseller`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ username, points: parseInt(points) })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showMessage(data.message, "success");
          closeResellerModal();
        } else {
          showMessage(data.message, "error");
        }
      });
    }

    // SHOW MESSAGE
    function showMessage(text, type) {
      const box = document.getElementById("message-box");
      box.textContent = text;
      box.className = `message ${type}`;
      box.style.display = "block";

      setTimeout(() => box.style.display = "none", 3000);
    }

    // LOGOUT
    function logout() {
      localStorage.clear();
      window.location.href = "/";
    }

    // CLOSE MODAL WHEN CLICKING OUTSIDE
    window.onclick = function(e) {
      if (e.target.classList.contains("modal")) {
        e.target.style.display = "none";
      }
    }
  </script>
</body>
</html>
